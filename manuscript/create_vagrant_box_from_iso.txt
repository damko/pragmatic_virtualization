## Create a Vagrant Template box from iso file

Checkout the _create_vagrant_box_from_iso_ branch of the _extra_ repository

    cd $pve
    git checkout create_vagrant_box_from_iso
    cd packer-templates

You'll be following these steps:

1. creation of a box using Packer starting from a Debian iso installer
1. import of the Packer box in Vagrant as template box

### Creation of a box using Packer - 1st step

Packer will download a net-install iso from the Debian servers and will use that iso to launch the installation process and create a virtual machine image compatible with Virtualbox and Vagrant.

Basically Packer will do what you do when you install Debian from a net-install cd and will adjust it for the virtualization environment.

#### Get the Packer scripts

    cd $pve/packer_templates
    tree
    .
    ├── http
    │   └── preseed.cfg
    ├── LICENCE
    ├── README.md
    ├── scripts
    │   ├── base.sh
    │   ├── cleanup.sh
    │   ├── vagrant.sh
    │   └── virtualbox.sh
    └── ta-debian-7-wheezy-virtualbox.json

If you have a look at the `ta-debian-7-wheezy-virtualbox.json` file you'll see that the Packer box is configured to have 1 core, 512MB ram and 10Gb hdd but it's easy to add a core or some ram later on.

Before creating the vm, check if the json file is valid:

    cd $pve/packer_templates
    packer validate ta-debian-7-wheezy-virtualbox.json

It should output "Template validated successfully."

Finally this is the command to create the fresh vm:

    cd $pve/packer_templates
    packer build ta-debian-7-wheezy-virtualbox.json

The command will take a while (~ 30 minutes) because of the download and the non-attended installation of the operating system but in the end it will show this message:

    ==> Builds finished. The artifacts of successful builds are:
    --> virtualbox-iso: 'virtualbox' provider box: debian-770-wheezy.box

_debian-770-wheezy.box_ is a file about 450MB big which lives inside the packer_template directory and contains the fresh virtual machine.

*Notes*:

1. The debian iso file name contains the version number and, as soon as new releases will be out and the 770 will be removed from the debian servers, the debian-770-wheezy.json file will be outdated and you'll get the "ISO download failed" error right after running the build command.
To fix the issue go on http://cdimage.debian.org/debian-cd/current/amd64/iso-cd/, check which is the latest net-inst version and copy its checksum from the MD5SUMS file. Then edit the .json file and update these variables at the top:

    * "iso_url": update the link to the iso file
    * "iso_md5": insert the new MD5 checksum
    * "vm_name": update the version

1. During the build process it is possible that the output will pause for quite a long time ( 5 minutes or so ) at the line _Waiting for SSH to become available..._. Don't quit the process and be patient.

1. If you are curious to see what happens during the non-attended installation of the operating system you can edit the ta-debian-7-wheezy-virtualbox.json file and change `"headless": true,` to `"headless": false,` and re-run the build process.


### Import of the Packer box into Vagrant and Virtualbox - 2nd step

Now that the debian-770-wheezy.box file is ready, the next step is to tell Vagrant to import the Packer box and to make it available in the system as a template. This command will do the trick:

    vagrant box add debian_wheezy_770_64bit ./debian-770-wheezy.box

_debian_wheezy_770_64bit_ will be the name of the Vagrant template and must be unique in the system. Imagine this Vagrant box as a "template" for a fresh Debian Wheezy 64bit based virtual machine that can be used to create as many Vagrant boxes as you want.

You can verify that Vagrant is now "aware" of the existence of this template asking Vagrant to list the Vagrant boxes (or "templates"):

    vagrant box list

Output:

> debian_wheezy_770_64bit (virtualbox, 0)

Now that the original Packer box has been added to the Vagrant boxes the file debian-770-wheezy.box can be deleted.

### Where are templates located?

Where is the "vagrant template vm" located on the workstation disk?

    ls -lh ~/.vagrant.d/boxes

Output:

> drwxr-xr-x 3 damko damko 4.0K 2014-11-17 20:27:33 debian_wheezy_770_64bit

    du -sh ~/.vagrant.d/boxes/*

Output:

> 442M    /home/damko/.vagrant.d/boxes/debian_wheezy_770_64bit


